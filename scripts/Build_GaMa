#!/bin/bash
#
# parametr prekladu pro GSO je -DGaMaOLSgso
# 
# $Id: Build_GaMa,v 1.3 2002/04/02 21:39:00 cepek Exp $

# pokud jsem v podadresari ./scripts, prejdu o jednu uroven vys
#
if pwd | grep /scripts$; then cd ..; fi
SCRIPTS=`pwd`/scripts

if [ ! -d expat ]
then
    scripts/build-gamalib-Makefile-expat
    exit 1
fi

( cd gamaprog/linux/lib ; rm -f gamalib.a *.o )

scripts/build-doc-html
scripts/build-gamalib-Makefile-expat
scripts/build-dictionaries
scripts/build-gamalib-Makefile


#--------------------------------------------------------------------------

CC=g++
CF="-I../../.. -Wall -pedantic"

cd gamaprog/linux/gama
 

rm -f gama Makefile* Makefile_* *.o

echo "# gama Makefile.pro generated by $0"           >> Makefile.pro
echo "# on" $(date) "by" $(whoami)                   >> Makefile.pro
echo "#"                                             >> Makefile.pro
echo                                                 >> Makefile.pro
cat   $SCRIPTS/platforms.defs             >> Makefile.pro
echo                                                 >> Makefile.pro
echo CPP=$CC                                         >> Makefile.pro
echo FCC=$CF                                         >> Makefile.pro 
echo GAMALIB=../lib/gamalib.a                        >> Makefile.pro
echo SRC=../../../                                   >> Makefile.pro
echo OBJ=                                            >> Makefile.pro
echo                                                 >> Makefile.pro
echo    "gama : gama.o \$(GAMALIB)"                  >> Makefile.pro
echo -e "\t\$(CPP) -o gama gama.o \$(GAMALIB)\n"     >> Makefile.pro

GAMADEP="\$(OBJ)"gama$( echo gama.cpp | ../../../scripts/gamalib_dep ../../.. )
GAMADEP="$GAMADEP gama_main.h"
GAMADEP="$GAMADEP $(find ../../../gamalib/local/results/text -name \*.h)"

echo    $GAMADEP                                     >> Makefile.pro
echo -e "\t\$(CPP) \$(FCC) -I. -c gama.cpp\n"        >> Makefile.pro


# .......................................................................

cd ..

rm -f Makefile*
echo "# GaMa Makefile.pro generated by $0"           >> Makefile.pro
echo "# on" $(date) "by" $(whoami)                   >> Makefile.pro
echo "#"                                             >> Makefile.pro
echo                                                 >> Makefile.pro
cat   $SCRIPTS/platforms.defs             >> Makefile.pro
echo                                                 >> Makefile.pro
echo    "all:"                                       >> Makefile.pro
echo -e "\tcd lib"                                   >> Makefile.pro
echo -e "\t\$(MAKE)"                                 >> Makefile.pro
echo -e "\t\$(MAKE) -f Makefile-expat"               >> Makefile.pro
echo -e "\tcd .."                                    >> Makefile.pro
echo -e "\tcd gama"                                  >> Makefile.pro
echo -e "\t\$(MAKE)"                                 >> Makefile.pro  


# ------------- GNU Makefiles to other formats  ------------------------

cd ..                
rm -rf win32-borland win32-msvc
mkdir  win32-borland win32-borland/gama  win32-borland/lib
mkdir  win32-msvc    win32-msvc/gama     win32-msvc/lib


sed s/^\#gnu.*:// < linux/gama/Makefile.pro      > linux/gama/Makefile
sed s/^\#gnu.*:// < linux/lib/Makefile.pro       > linux/lib/Makefile
sed s/^\#gnu.*:// < linux/lib/Makefile-expat.pro > linux/lib/Makefile-expat


sed s/^\#win32-borland.*:// < linux/Makefile.pro       \
                            > win32-borland/Makefile   
sed s/^\#win32-borland.*:// < linux/gama/Makefile.pro       \
                            > win32-borland/gama/Makefile   
sed s/^\#win32-borland.*:// < linux/lib/Makefile.pro        \
                            > win32-borland/lib/Makefile  
sed s/^\#win32-borland.*:// < linux/lib/Makefile-expat.pro  \
                            > win32-borland/lib/wwwMakefile-expat


sed s/^\#win32-msvc.*://    < linux/Makefile.pro       \
                            > win32-msvc/Makefile   
sed s/^\#win32-msvc.*://    < linux/gama/Makefile.pro       \
                            > win32-msvc/gama/Makefile   
sed s/^\#win32-msvc.*://    < linux/lib/Makefile.pro        \
                            > win32-msvc/lib/Makefile  
sed s/^\#win32-msvc.*://    < linux/lib/Makefile-expat.pro  \
                            > win32-msvc/lib/Makefile-expat

rm `find linux -name *.pro`

for i in $(find win32-borland win32-msvc)
do
   if [ -f $i ]; then
      unix2dos $i
   fi
done


# ----------------------------------------------------------------------

echo
echo Compiling gamalib ...
echo 
( cd linux/lib ;  make; make -f Makefile-expat )  
( cd linux/gama ; make ) 

#########








