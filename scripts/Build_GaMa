#!/bin/sh
#
# parametr prekladu pro GSO je -DGaMaOLSgso
# 
# $Id: Build_GaMa,v 1.12 2002/10/01 17:23:25 cepek Exp $

# pokud jsem v podadresari ./scripts, prejdu o jednu uroven vys
#
if pwd | grep /scripts$; then cd ..; fi
SCRIPTS=`pwd`/scripts

if [ ! -d expat ]
then
    scripts/build-gamalib-Makefile-expat
    exit 1
fi

( cd gamaprog/linux/lib ; rm -f gamalib.a *.o )

for i in scripts/build-gamalib-Makefile-expat \
         scripts/build-dictionaries \
         scripts/build-ellipsoids \
         scripts/build-gamalib-Makefile 
do
   if [ -f $i ]
   then
       $i
   fi
done


#--------------------------------------------------------------------------


cd gamaprog/linux/gama
 

rm -f gama Makefile* Makefile_* *.o

echo "# gama Makefile generated by $0"                  >> Makefile.pro
echo "#"                                                >> Makefile.pro
echo                                                    >> Makefile.pro
cat   $SCRIPTS/platforms.defs                           >> Makefile.pro
echo                                                    >> Makefile.pro
echo -e "\$(P_GAMA) : gama.\$(OBJ) ../lib/\$(GAMALIB)"  >> Makefile.pro
echo -e "\t\$(LINK) \$(LFLAGS)\$(P_GAMA) gama.\$(OBJ) \$(LIBS) ../lib/\$(GAMALIB)\n" >> Makefile.pro

GAMADEP="\$(OBJDIR)"gama$( echo ../../linux/gama/gama.cpp | ../../../scripts/gamalib_dep ../../.. )
GAMADEP="$GAMADEP ../../linux/gama/gama_main.h"
GAMADEP="$GAMADEP $(find ../../../gamalib/local/results/text -name \*.h)"

echo    $GAMADEP                                              >> Makefile.pro
echo -e "\t\$(CXX) \$(CXXFLAGS) -I. -c ../../linux/gama/gama.cpp\n" >> Makefile.pro


# .......................................................................

cd ..

rm -f Makefile*
echo "# GaMa Makefile generated by $0"               >> Makefile.pro
echo "#"                                             >> Makefile.pro
echo                                                 >> Makefile.pro
cat   $SCRIPTS/platforms.defs                        >> Makefile.pro
echo                                                 >> Makefile.pro
echo    "all:"                                       >> Makefile.pro
echo -e "\tcd lib"                                   >> Makefile.pro
echo -e "\t\$(MAKE)"                                 >> Makefile.pro
echo -e "\t\$(MAKE) -f Makefile-expat"               >> Makefile.pro
echo -e "\tcd .."                                    >> Makefile.pro
echo -e "\tcd gama"                                  >> Makefile.pro
echo -e "\t\$(MAKE)"                                 >> Makefile.pro  


# ------------- GNU Makefiles to other formats  ------------------------

cd ..                
# must not be removed, present at CVS !!!!
#    rm -rf win32-borland win32-msvc
#    mkdir  win32-borland win32-borland/gama  win32-borland/lib
#    mkdir  win32-msvc    win32-msvc/gama     win32-msvc/lib


sed s/^\#gnu[\ \t]*:// < linux/gama/Makefile.pro      > linux/gama/Makefile
sed s/^\#gnu[\ \t]*:// < linux/lib/Makefile.pro       > linux/lib/Makefile
sed s/^\#gnu[\ \t]*:// < linux/lib/Makefile-expat.pro > linux/lib/Makefile-expat


sed s/^\#win32-borland[\ \t]*:// < linux/Makefile.pro            \
                                 > win32-borland/Makefile   
sed s/^\#win32-borland[\ \t]*:// < linux/gama/Makefile.pro       \
                                 > win32-borland/gama/Makefile   
sed s/^\#win32-borland[\ \t]*:// < linux/lib/Makefile.pro        \
                                 > win32-borland/lib/Makefile  
sed s/^\#win32-borland[\ \t]*:// < linux/lib/Makefile-expat.pro  \
                                 > win32-borland/lib/Makefile-expat


sed s/^\#win32-msvc[\ \t]*://    < linux/Makefile.pro            \
                                 > win32-msvc/Makefile   
sed s/^\#win32-msvc[\ \t]*://    < linux/gama/Makefile.pro       \
                                 > win32-msvc/gama/Makefile   
sed s/^\#win32-msvc[\ \t]*://    < linux/lib/Makefile.pro        \
                            > win32-msvc/lib/Makefile  
sed s/^\#win32-msvc[\ \t]*://    < linux/lib/Makefile-expat.pro  \
                                 > win32-msvc/lib/Makefile-expat


rm `find linux | grep \.pro\$`

if [ "$(which unix2dos)" ]; then
   for i in $(find win32-borland win32-msvc | grep -v CVS)
   do
      if [ -f $i ]; then
         unix2dos $i
      fi
   done
fi

# ----------------------------------------------------------------------

echo
echo Compiling gamalib ...
echo 
( cd linux/lib ;  make; make -f Makefile-expat )  
( cd linux/gama ; make ) 

#########








